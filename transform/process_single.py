
import asyncio
import logging
from motor.motor_asyncio import AsyncIOMotorClient
from datetime import datetime, timezone

from config import MONGO_URI, MONGO_DB_NAME
from main import TransformOrchestrator

# Setup logging
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

async def run_single_process():
    # 1. Initialize DB and Orchestator
    client = AsyncIOMotorClient(MONGO_URI)
    db = client[MONGO_DB_NAME]
    page_versions_col = db["page_versions"]
    
    orchestrator = TransformOrchestrator()
    
    # 3. Create a sample document
    sample_doc = {
  "_id": "aaaaa",
  "page_id": "aaaaa",
  "version": 1,
  "content": "{\"type\":\"doc\",\"content\":[{\"type\":\"paragraph\",\"content\":[{\"text\":\"To provide access to user for any games on fury.\",\"type\":\"text\"}]},{\"type\":\"heading\",\"attrs\":{\"level\":2},\"content\":[{\"type\":\"hardBreak\"},{\"text\":\"Games\",\"type\":\"text\"}]},{\"type\":\"paragraph\",\"content\":[{\"text\":\"Games onboarded so far with links to their zk:\",\"type\":\"text\"}]},{\"type\":\"table\",\"attrs\":{\"layout\":\"default\",\"width\":760.0,\"localId\":\"f2cd5b8e-518b-4c2a-bcf3-87aa957e4ba9\"},\"content\":[{\"type\":\"tableRow\",\"content\":[{\"type\":\"tableHeader\",\"attrs\":{\"colspan\":1,\"rowspan\":1,\"colwidth\":[101.0]},\"content\":[{\"type\":\"paragraph\",\"content\":[{\"text\":\"Game(GameID)\",\"type\":\"text\",\"marks\":[{\"type\":\"strong\"}]}]}]},{\"type\":\"tableHeader\",\"attrs\":{\"colspan\":1,\"rowspan\":1,\"colwidth\":[350.0]},\"content\":[{\"type\":\"paragraph\",\"content\":[{\"text\":\"Dev ZK Url\",\"type\":\"text\",\"marks\":[{\"type\":\"strong\"}]}]}]}]},{\"type\":\"tableRow\",\"content\":[{\"type\":\"tableCell\",\"attrs\":{\"colspan\":1,\"rowspan\":1,\"colwidth\":[101.0]},\"content\":[{\"type\":\"paragraph\",\"content\":[{\"text\":\"Baloot(25)\",\"type\":\"text\"}]}]},{\"type\":\"tableCell\",\"attrs\":{\"colspan\":1,\"rowspan\":1,\"colwidth\":[350.0]},\"content\":[{\"type\":\"paragraph\",\"content\":[{\"text\":\"http://172.30.190.127:9090/home?zkPath=/mflconfig/admin/baloot\",\"type\":\"text\",\"marks\":[{\"type\":\"link\",\"attrs\":{\"href\":\"http://172.30.190.127:9090/home?zkPath=/mflconfig/admin/baloot\"}}]}]}]}]},{\"type\":\"tableRow\",\"content\":[{\"type\":\"tableCell\",\"attrs\":{\"colspan\":1,\"rowspan\":1,\"colwidth\":[101.0]},\"content\":[{\"type\":\"paragraph\",\"content\":[{\"text\":\"Carioca(100)\",\"type\":\"text\"}]}]},{\"type\":\"tableCell\",\"attrs\":{\"colspan\":1,\"rowspan\":1,\"colwidth\":[350.0]},\"content\":[{\"type\":\"paragraph\",\"content\":[{\"text\":\"http://172.30.190.127:9090/home?zkPath=/mflconfig/admin/carioca\",\"type\":\"text\",\"marks\":[{\"type\":\"link\",\"attrs\":{\"href\":\"http://172.30.190.127:9090/home?zkPath=/mflconfig/admin/carioca\"}}]}]}]}]},{\"type\":\"tableRow\",\"content\":[{\"type\":\"tableCell\",\"attrs\":{\"colspan\":1,\"rowspan\":1,\"colwidth\":[101.0]},\"content\":[{\"type\":\"paragraph\",\"content\":[{\"text\":\"Carromgold(8)\",\"type\":\"text\"}]}]},{\"type\":\"tableCell\",\"attrs\":{\"colspan\":1,\"rowspan\":1,\"colwidth\":[350.0]},\"content\":[{\"type\":\"paragraph\",\"content\":[{\"text\":\"http://172.30.190.127:9090/home?zkPath=/mflconfig/admin/carromgold\",\"type\":\"text\",\"marks\":[{\"type\":\"link\",\"attrs\":{\"href\":\"http://172.30.190.127:9090/home?zkPath=/mflconfig/admin/carromgold\"}}]}]}]}]},{\"type\":\"tableRow\",\"content\":[{\"type\":\"tableCell\",\"attrs\":{\"colspan\":1,\"rowspan\":1,\"colwidth\":[101.0]},\"content\":[{\"type\":\"paragraph\",\"content\":[{\"text\":\"Ludo(30)\",\"type\":\"text\"}]}]},{\"type\":\"tableCell\",\"attrs\":{\"colspan\":1,\"rowspan\":1,\"colwidth\":[350.0]},\"content\":[{\"type\":\"paragraph\",\"content\":[{\"text\":\"http://172.30.190.127:9090/home?zkPath=/mflconfig/admin/ludo\",\"type\":\"text\",\"marks\":[{\"type\":\"link\",\"attrs\":{\"href\":\"http://172.30.190.127:9090/home?zkPath=/mflconfig/admin/ludo\"}}]}]}]}]},{\"type\":\"tableRow\",\"content\":[{\"type\":\"tableCell\",\"attrs\":{\"colspan\":1,\"rowspan\":1,\"colwidth\":[101.0]},\"content\":[{\"type\":\"paragraph\",\"content\":[{\"text\":\"LudoIG(31)\",\"type\":\"text\"}]}]},{\"type\":\"tableCell\",\"attrs\":{\"colspan\":1,\"rowspan\":1,\"colwidth\":[350.0]},\"content\":[{\"type\":\"paragraph\",\"content\":[{\"text\":\"http://172.30.190.127:9090/home?zkPath=/mflconfig/admin/ludoig\",\"type\":\"text\",\"marks\":[{\"type\":\"link\",\"attrs\":{\"href\":\"http://172.30.190.127:9090/home?zkPath=/mflconfig/admin/ludoig\"}}]}]}]}]},{\"type\":\"tableRow\",\"content\":[{\"type\":\"tableCell\",\"attrs\":{\"colspan\":1,\"rowspan\":1,\"colwidth\":[101.0]},\"content\":[{\"type\":\"paragraph\",\"content\":[{\"text\":\"Parchisi(110)\",\"type\":\"text\"}]}]},{\"type\":\"tableCell\",\"attrs\":{\"colspan\":1,\"rowspan\":1,\"colwidth\":[350.0]},\"content\":[{\"type\":\"paragraph\",\"content\":[{\"text\":\"http://172.30.190.127:9090/home?zkPath=/mflconfig/admin/parchisi\",\"type\":\"text\",\"marks\":[{\"type\":\"link\",\"attrs\":{\"href\":\"http://172.30.190.127:9090/home?zkPath=/mflconfig/admin/parchisi\"}}]}]}]}]},{\"type\":\"tableRow\",\"content\":[{\"type\":\"tableCell\",\"attrs\":{\"colspan\":1,\"rowspan\":1,\"colwidth\":[101.0]},\"content\":[{\"type\":\"paragraph\",\"content\":[{\"text\":\"TPG(3)\",\"type\":\"text\"}]}]},{\"type\":\"tableCell\",\"attrs\":{\"colspan\":1,\"rowspan\":1,\"colwidth\":[350.0]},\"content\":[{\"type\":\"paragraph\",\"content\":[{\"text\":\"http://172.30.190.127:9090/home?zkPath=/mflconfig/admin/teenpattigold\",\"type\":\"text\",\"marks\":[{\"type\":\"link\",\"attrs\":{\"href\":\"http://172.30.190.127:9090/home?zkPath=/mflconfig/admin/teenpattigold\"}}]}]}]}]},{\"type\":\"tableRow\",\"content\":[{\"type\":\"tableCell\",\"attrs\":{\"colspan\":1,\"rowspan\":1,\"colwidth\":[101.0]},\"content\":[{\"type\":\"paragraph\",\"content\":[{\"text\":\"TwentyNine(74)\",\"type\":\"text\"}]}]},{\"type\":\"tableCell\",\"attrs\":{\"colspan\":1,\"rowspan\":1,\"colwidth\":[350.0]},\"content\":[{\"type\":\"paragraph\",\"content\":[{\"text\":\"http://172.30.190.127:9090/home?zkPath=/mflconfig/admin/twentynine\",\"type\":\"text\",\"marks\":[{\"type\":\"link\",\"attrs\":{\"href\":\"http://172.30.190.127:9090/home?zkPath=/mflconfig/admin/twentynine\"}}]}]}]}]},{\"type\":\"tableRow\",\"content\":[{\"type\":\"tableCell\",\"attrs\":{\"colspan\":1,\"rowspan\":1,\"colwidth\":[101.0]},\"content\":[{\"type\":\"paragraph\",\"content\":[{\"text\":\"Wordlounge (15)(Wordtravel)\",\"type\":\"text\"}]}]},{\"type\":\"tableCell\",\"attrs\":{\"colspan\":1,\"rowspan\":1,\"colwidth\":[350.0]},\"content\":[{\"type\":\"paragraph\",\"content\":[{\"text\":\"http://172.30.190.127:9090/home?zkPath=/mflconfig/admin/wordtravel\",\"type\":\"text\",\"marks\":[{\"type\":\"link\",\"attrs\":{\"href\":\"http://172.30.190.127:9090/home?zkPath=/mflconfig/admin/wordtravel\"}}]}]}]}]},{\"type\":\"tableRow\",\"content\":[{\"type\":\"tableCell\",\"attrs\":{\"colspan\":1,\"rowspan\":1,\"colwidth\":[101.0]},\"content\":[{\"type\":\"paragraph\",\"content\":[{\"text\":\"ParchisiIG\",\"type\":\"text\"}]}]},{\"type\":\"tableCell\",\"attrs\":{\"colspan\":1,\"rowspan\":1,\"colwidth\":[350.0]},\"content\":[{\"type\":\"paragraph\",\"content\":[{\"text\":\"http://172.30.190.127:9090/home?zkPath=/mflconfig/admin/parchisiig\",\"type\":\"text\",\"marks\":[{\"type\":\"link\",\"attrs\":{\"href\":\"http://172.30.190.127:9090/home?zkPath=/mflconfig/admin/parchisiig\"}}]}]}]}]}]},{\"type\":\"paragraph\",\"content\":[{\"text\":\" For prod: \",\"type\":\"text\"},{\"text\":\"http://zookeeper.moonfroglabs.com:9090/home?zkPath=/mflconfig/admin\",\"type\":\"text\",\"marks\":[{\"type\":\"link\",\"attrs\":{\"href\":\"http://zookeeper.moonfroglabs.com:9090/home?zkPath=/mflconfig/admin\"}}]},{\"text\":\" + [/gamename]\",\"type\":\"text\"}]},{\"type\":\"paragraph\"},{\"type\":\"heading\",\"attrs\":{\"level\":2},\"content\":[{\"text\":\"Modules\",\"type\":\"text\"}]},{\"type\":\"paragraph\",\"content\":[{\"text\":\"Modules are basic functionalities that are divided in modules:\",\"type\":\"text\"}]},{\"type\":\"bulletList\",\"content\":[{\"type\":\"listItem\",\"content\":[{\"type\":\"paragraph\",\"content\":[{\"text\":\"FetchBlob\",\"type\":\"text\",\"marks\":[{\"type\":\"underline\"},{\"type\":\"strong\"}]},{\"text\":\": To check a particular user profile  from couch-base.\",\"type\":\"text\"}]}]},{\"type\":\"listItem\",\"content\":[{\"type\":\"paragraph\",\"content\":[{\"text\":\"EconomyGrant\",\"type\":\"text\",\"marks\":[{\"type\":\"underline\"},{\"type\":\"strong\"}]},{\"text\":\": To grant economy items to a particular user based on PID.\",\"type\":\"text\"}]}]},{\"type\":\"listItem\",\"content\":[{\"type\":\"paragraph\",\"content\":[{\"text\":\"Experiments\",\"type\":\"text\",\"marks\":[{\"type\":\"underline\"},{\"type\":\"strong\"}]},{\"text\":\": Experiment Manager of that particular game.\",\"type\":\"text\"}]}]},{\"type\":\"listItem\",\"content\":[{\"type\":\"paragraph\",\"content\":[{\"text\":\"Cadence\",\"type\":\"text\",\"marks\":[{\"type\":\"underline\"},{\"type\":\"strong\"}]},{\"text\":\": Cadence page of that particular game.\",\"type\":\"text\"}]}]}]},{\"type\":\"heading\",\"attrs\":{\"level\":2},\"content\":[{\"type\":\"hardBreak\"},{\"text\":\"Access\",\"type\":\"text\"}]},{\"type\":\"paragraph\",\"content\":[{\"text\":\"Users can be provided access based on their usage. Types of access accessible is:\",\"type\":\"text\"}]},{\"type\":\"orderedList\",\"attrs\":{\"order\":1},\"content\":[{\"type\":\"listItem\",\"content\":[{\"type\":\"paragraph\",\"content\":[{\"text\":\"read\",\"type\":\"text\",\"marks\":[{\"type\":\"underline\"},{\"type\":\"strong\"}]},{\"text\":\" = 1 : User can \",\"type\":\"text\"},{\"text\":\"read\",\"type\":\"text\",\"marks\":[{\"type\":\"strong\"}]},{\"text\":\" only\",\"type\":\"text\"}]}]},{\"type\":\"listItem\",\"content\":[{\"type\":\"paragraph\",\"content\":[{\"text\":\"create\",\"type\":\"text\",\"marks\":[{\"type\":\"underline\"},{\"type\":\"strong\"}]},{\"text\":\" = 2 : User can \",\"type\":\"text\"},{\"text\":\"create\",\"type\":\"text\",\"marks\":[{\"type\":\"strong\"}]},{\"text\":\" and perform all above operations\",\"type\":\"text\"}]}]},{\"type\":\"listItem\",\"content\":[{\"type\":\"paragraph\",\"content\":[{\"text\":\"update\",\"type\":\"text\",\"marks\":[{\"type\":\"underline\"},{\"type\":\"strong\"}]},{\"text\":\" = 3 : User can \",\"type\":\"text\"},{\"text\":\"update\",\"type\":\"text\",\"marks\":[{\"type\":\"strong\"}]},{\"text\":\" and perform all above operations\",\"type\":\"text\"}]}]},{\"type\":\"listItem\",\"content\":[{\"type\":\"paragraph\",\"content\":[{\"text\":\"delete\",\"type\":\"text\",\"marks\":[{\"type\":\"underline\"},{\"type\":\"strong\"}]},{\"text\":\" = 4 : User can \",\"type\":\"text\"},{\"text\":\"delete\",\"type\":\"text\",\"marks\":[{\"type\":\"strong\"}]},{\"text\":\" and perform all above operations\",\"type\":\"text\"}]}]},{\"type\":\"listItem\",\"content\":[{\"type\":\"paragraph\",\"content\":[{\"text\":\"all\",\"type\":\"text\",\"marks\":[{\"type\":\"underline\"},{\"type\":\"strong\"}]},{\"text\":\" = 5 : This includes all four access mentioned above.\",\"type\":\"text\"}]}]}]},{\"type\":\"paragraph\"},{\"type\":\"heading\",\"attrs\":{\"level\":2},\"content\":[{\"text\":\"How to grant access:\",\"type\":\"text\"}]},{\"type\":\"paragraph\",\"content\":[{\"text\":\"Every game has a \",\"type\":\"text\"},{\"text\":\"roles\",\"type\":\"text\",\"marks\":[{\"type\":\"textColor\",\"attrs\":{\"color\":\"#36b37e\"}}]},{\"text\":\" node in ZK config ( \",\"type\":\"text\"},{\"text\":\"http://172.30.190.127:9090/home?zkPath=/mflconfig/admin/carromgold/roles\",\"type\":\"text\",\"marks\":[{\"type\":\"link\",\"attrs\":{\"href\":\"http://172.30.190.127:9090/home?zkPath=/mflconfig/admin/carromgold/roles\"}}]},{\"text\":\") which is used to grant access to all users based on modules and access: \",\"type\":\"text\"},{\"type\":\"hardBreak\"},{\"type\":\"hardBreak\"},{\"text\":\"We can use \",\"type\":\"text\"},{\"text\":\"DefaultMoonfrogAccounts\",\"type\":\"text\",\"marks\":[{\"type\":\"textColor\",\"attrs\":{\"color\":\"#ff5630\"}},{\"type\":\"strong\"}]},{\"text\":\" property to grant default access to each person with @moonfroglabs domain ID. This will again follow {ModuleName: accessType} key-value pair.\",\"type\":\"text\"}]},{\"type\":\"mediaSingle\",\"attrs\":{\"layout\":\"center\",\"width\":1163,\"widthType\":\"pixel\"},\"content\":[{\"type\":\"media\",\"attrs\":{\"width\":1163,\"id\":\"8200cf23-1b91-48a5-9a7a-655118839be0\",\"collection\":\"contentId-2750709765\",\"type\":\"file\",\"height\":439}},{\"type\":\"caption\",\"content\":[{\"text\":\"Roles\",\"type\":\"text\",\"marks\":[{\"type\":\"textColor\",\"attrs\":{\"color\":\"#36b37e\"}}]},{\"text\":\" and \",\"type\":\"text\"},{\"text\":\"DefaultMoonfrogAccounts \",\"type\":\"text\",\"marks\":[{\"type\":\"textColor\",\"attrs\":{\"color\":\"#ff5630\"}},{\"type\":\"strong\"}]},{\"text\":\"access\",\"type\":\"text\"}]}]},{\"type\":\"paragraph\"},{\"type\":\"paragraph\",\"content\":[{\"text\":\"Also inside roles we will follow structure of keys as \",\"type\":\"text\"},{\"text\":\"ModuleName+AccessType\",\"type\":\"text\",\"marks\":[{\"type\":\"strong\"}]},{\"text\":\" to grant access. Here key will be an array of “userEmail” with @moonfroglabs domain name. \",\"type\":\"text\"}]},{\"type\":\"mediaSingle\",\"attrs\":{\"layout\":\"center\",\"width\":1168,\"widthType\":\"pixel\"},\"content\":[{\"type\":\"media\",\"attrs\":{\"width\":1168,\"id\":\"ca12b0f6-55d8-4165-98d7-c39b9b231325\",\"collection\":\"contentId-2750709765\",\"type\":\"file\",\"height\":776}}]},{\"type\":\"paragraph\"},{\"type\":\"paragraph\",\"content\":[{\"text\":\"Step 1: Go to respected ZK URL.\",\"type\":\"text\"},{\"type\":\"hardBreak\"},{\"text\":\"Step 2: Locate Game and open its roles.\",\"type\":\"text\"},{\"type\":\"hardBreak\"},{\"text\":\"Step 3: Get user email (with @moonfroglabs.com domain), game, FeatureName, AccessType.\",\"type\":\"text\"},{\"type\":\"hardBreak\"},{\"text\":\"Step 4: Locate FeatureName+AccessType key, if not available create one property.\",\"type\":\"text\"},{\"type\":\"hardBreak\"},{\"text\":\"Step 5: Add user email in values.\",\"type\":\"text\"}]},{\"type\":\"paragraph\"}],\"version\":1}",
  "content_hash": "cef2b36c9c44ec86d6244eeb33f6d0a5a33f12c2090e2cf931dd9100c64fb188",
  "collected_at": "2026-02-17T05:57:43.829596"
}
    
    # Insert with a versioned ID to match the pipeline's expected format
    doc_id = "demo_page_123s_v1"
    sample_doc["_id"] = doc_id
    
    logger.info(f"Inserting sample document: {doc_id}")
    await page_versions_col.replace_one({"_id": doc_id}, sample_doc, upsert=True)
    
    # 4. Process the document
    logger.info("Starting processing...")
    await orchestrator.process_document(sample_doc)
    
    # 5. Verify and display result
    transformed_col = db["transformed_documents"]
    result = await transformed_col.find_one({"_id": doc_id})
    
    if result:
        print("\n" + "="*50)
        print("TRANSFORMATION SUCCESSFUL")
        print("="*50)
        print(f"Schema Used: {result.get('schema_id')}")
        print(f"Content:\n{import_json_indent(result.get('content'))}")
        print("="*50 + "\n")
    else:
        logger.error("Transformation result not found in database.")

def import_json_indent(data):
    import json
    return json.dumps(data, indent=2)

if __name__ == "__main__":
    asyncio.run(run_single_process())
